#!/bin/sh

# movieme
# create an animated gif from a movie file

FILE=
START=0
DURATION=5
FRAMERATE=7
DITHER=
WIDTH=500
INTERACTIVE=NO
CONTINUE=NO

TEMPDIR=/tmp/movieme

# "parse" options
while [[ $# -gt 0 ]]; do
  case $1 in
    --start|-s)
      shift
      START=$1
      ;;
    --duration|-d)
      shift
      DURATION=$1
      ;;
    --framerate|-f)
      shift
      FRAMERATE=$1
      ;;
    --no-dither|-n)
      DITHER=+dither
      ;;
    --width|-w)
      shift
      WIDTH=$1
      ;;
    --interactive|-i)
      if [[ "$CLEANUP" == "YES" ]]; then
        echo "Invalid arguments; --interactive and --cleanup cannot be used together."
        exit 1
      fi
      INTERACTIVE=YES
      ;;
    --continue)
      CONTINUE=YES
      ;;
    --cleanup)
      if [[ "$INTERACTIVE" == "YES" ]]; then
        echo "Invalid arguments; --interactive and --cleanup cannot be used together."
        exit 1
      fi
      CLEANUP=YES
      ;;
    *)
      if [[ -f "$1" ]]; then
        if [[ -z "$FILE" ]]; then
          FILE=$1
        else
          echo "Too many files in arguments; using first."
        fi
      else
        echo "Unrecognised argument \"$1\"." >&2
      fi
      ;;
  esac
  shift
done

stats() {
  echo "$(basename $0)
      File: $FILE
Start time: $START
  Duration: $DURATION
 Framerate: $FRAMERATE
     Width: $WIDTH
"
}

cleanup() {
  rm -rf "$TEMPDIR"
}

extractFrames() {
  # create tmp dir
  mkdir -p "$TEMPDIR"

  ffmpeg \
    -i "$FILE" \
    -f image2 \
    -vf "scale=iw*sar:ih" \
    -ss "$START" \
    -t "$DURATION" \
    -r "$FRAMERATE" \
    -loglevel fatal \
    "$TEMPDIR/frame-%05d.png"
}

animate() {
  convert \
    -verbose \
    -delay 0 \
    $DITHER \
    -loop 0 \
    -resize $WIDTH \
    -layers OptimizeTransparency \
    "$TEMPDIR/frame-[0-9]*.png" \
    "$HOME/Desktop/Animated $(zdate "%Y-%m-%d at %H.%M.%S").gif"
}

if [[ "$CONTINUE" == "NO" ]]; then

  if ! [[ -f "$FILE" ]]; then
    echo "Supplied file does not exist."
    exit 1
  fi

  stats
  cleanup
  extractFrames

else

  source "$TEMPDIR/interactive.meta.sh"
  stats

fi

if [[ "$INTERACTIVE" == "YES" ]]; then

  echo "FILE=$FILE
START=$START
DURATION=$DURATION
FRAMERATE=$FRAMERATE
DITHER=$DITHER
WIDTH=$WIDTH" > "$TEMPDIR/interactive.meta.sh"
  echo "Finished splitting frames. Manually edit files in $TEMPDIR, then run \"$(basename $0) --continue\"."
  exit

else

  animate

  if [[ "$CLEANUP" == "YES" ]]; then
    cleanup
  fi

fi
