#!/bin/sh

# movieme
# create an animated gif from a movie file

FILE="$1"
START=0
DURATION=5
FRAMERATE=7
DITHER=-dither
WIDTH=500
WAIT=NO

shift

# "parse" options
while [[ $# -gt 0 ]]; do
  case $1 in
    --start|-s)
      shift
      START=$1
      ;;
    --duration|-d)
      shift
      DURATION=$1
      ;;
    --framerate|-f)
      shift
      FRAMERATE=$1
      ;;
    --no-dither|-n)
      DITHER=+dither
      ;;
    --width|-w)
      shift
      WIDTH=$1
      ;;
    --wait|-x)
      WAIT=YES
      ;;
    *)
      echo "Unrecognised argument \"$1\"." >&2
      ;;
  esac
  shift
done

if ! [[ -f "$FILE" ]]; then
  echo "Supplied file does not exist."
  exit 1
fi

echo "movieme
      File: $FILE
Start time: $START
  Duration: $DURATION
 Framerate: $FRAMERATE
     Width: $WIDTH"

# cleanup
rm -rf /tmp/movieme

# create tmp dir
mkdir -p /tmp/movieme

# split the movie into constituent frames
ffmpeg \
  -i "$FILE" \
  -f image2 \
  -vf "scale=iw*sar:ih" \
  -ss "$START" \
  -t "$DURATION" \
  -r "$FRAMERATE" \
  -loglevel fatal \
  /tmp/movieme/d-%05d.png

if [[ "$WAIT" == "YES" ]]; then
  echo "Finished splitting frames. Manually edit files in /tmp/movieme, then press any key to continue."
  read -n 1 -s
fi

# animate it
convert \
  -verbose \
  -delay 0 \
  $DITHER \
  -loop 0 \
  -resize $WIDTH \
  -layers OptimizeTransparency \
  /tmp/movieme/* \
  "$HOME/Desktop/Animated $(zdate "%Y-%m-%d at %H.%M.%S").gif"
